<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MACROSv2.0-Pre-Alpha</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #006DB2; /* azul */
      --secondary-color: #28a745; /* verde */
      --background-color: #f0f2f5;
      --text-color: #333;
      --card-background: #fff;
      --border-radius: 8px;
      --shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    body.dark-mode {
      --background-color: #18191a;
      --text-color: #e4e6eb;
      --card-background: #242526;
      --shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--background-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    .container {
      max-width: 1200px;
      margin: auto;
    }

    .card {
      background-color: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 20px;
      transition: background-color 0.3s, box-shadow 0.3s;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input[type="text"], select, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      box-sizing: border-box;
      background-color: inherit;
      color: inherit;
    }

    textarea {
      resize: vertical;
    }

    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      margin-right: 10px;
      transition: background-color 0.3s;
    }

    /* Botón primario azul */
    .btn-primary {
      background-color: #006DB2;
      color: #fff;
    }
    .btn-primary:hover {
      background-color: #005a91;
    }

    /* Botón secundario verde */
    .btn-secondary {
      background-color: #28a745;
      color: #fff;
    }
    .btn-secondary:hover {
      background-color: #1e7e34;
    }

    /* Botones de CEX (se mantienen) */
    .btn-cex-good {
      background-color: #28a745;
      color: white;
    }
    .btn-cex-bad {
      background-color: #dc3545;
      color: white;
    }
    .btn-cex-none {
      background-color: #6c757d;
      color: white;
    }

    /* Botón de Dark Mode */
    .dark-mode-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #006DB2;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: background-color 0.3s;
    }
    .dark-mode-toggle:hover {
      background-color: #005a91;
    }

    /* Botones "+" y ⚙ (los de quick notes arriba) */
    #quickNoteForm button,
    .quick-notes h3 button {
      background-color: #006DB2;
      color: #fff;
    }
    #quickNoteForm button:hover,
    .quick-notes h3 button:hover {
      background-color: #005a91;
    }

    /* Botones dentro de cada Quick Note */
    .quick-note-item button {
      background-color: #28a745;
      color: #fff;
    }
    .quick-note-item button:hover {
      background-color: #1e7e34;
    }

    .btn:hover {
      opacity: 0.9;
    }

    .quick-notes, .history {
      margin-top: 20px;
    }

    .quick-note-item, .history-item {
      border-bottom: 1px solid #ccc;
      padding: 10px 0;
    }

    .quick-note-item:last-child, .history-item:last-child {
      border-bottom: none;
    }

    .note-actions button {
      margin-left: 5px;
    }

    .undo-container {
      margin-top: 15px;
    }

    .cex-options button {
      margin-right: 10px;
      margin-bottom: 10px;
    }

    .reasons {
      margin-top: 10px;
    }

    .reason-btn {
      background-color: #17a2b8;
      color: white;
      margin-right: 5px;
      margin-bottom: 5px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: var(--card-background);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      z-index: 1000;
      max-height: 80vh;
      overflow-y: auto;
      width: 90%;
      max-width: 600px;
    }

    .modal.active {
      display: block;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .modal-header h3 {
      margin: 0;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5em;
      cursor: pointer;
      color: var(--text-color);
    }

    .backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 999;
    }

    .backdrop.active {
      display: block;
    }

    @media (max-width: 768px) {
      .form-group {
        margin-bottom: 10px;
      }

      .btn {
        margin-bottom: 10px;
        width: 100%;
      }

      .modal {
        width: 95%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>MACROSv2.0-Pre-Alpha</h2>

    <div class="card">
      <form id="macroForm">
        <div class="form-group">
          <label for="brand">Marca:</label>
          <select id="brand" required>
            <option value="">Selecciona una marca</option>
            <option value="KOHLER">KOHLER</option>
            <option value="HWM">HWM</option>
            <option value="Sterling">Sterling</option>
            <option value="Robern">Robern</option>
            <option value="Kallista">Kallista</option>
            <option value="Novita">Novita</option>
            <option value="Mira">Mira</option>
            <option value="DECO">DECO</option>
            <option value="Clarity">Clarity</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label for="contactType">Tipo de Contacto:</label>
          <select id="contactType" required>
            <option value="">Selecciona un tipo</option>
            <option value="Call">Call</option>
            <option value="Chat">Chat</option>
            <option value="Case">Case</option>
          </select>
        </div>

        <div class="form-group">
          <label for="name">Nombre:</label>
          <input type="text" id="name" required>
        </div>

        <div class="form-group">
          <label for="order">Orden #:</label>
          <input type="text" id="order">
        </div>

        <div class="form-group">
          <label for="inquiry">Inquiry:</label>
          <textarea id="inquiry" rows="3" required></textarea>
        </div>

        <div class="form-group">
          <label for="action">Action Taken:</label>
          <textarea id="action" rows="3" required></textarea>
        </div>

        <div class="form-group">
          <label>CEX:</label>
          <div class="cex-options">
            <button type="button" class="btn btn-cex-good" data-cex="Good">Good</button>
            <button type="button" class="btn btn-cex-bad" data-cex="Bad">Bad</button>
            <button type="button" class="btn btn-cex-none" data-cex="None">None</button>
          </div>
          <div class="reasons" id="reasonsContainer"></div>
        </div>

        <div class="form-group">
          <button type="button" id="copySaveBtn" class="btn btn-primary">Copiar y Guardar</button>
          <button type="button" id="openHistoryBtn" class="btn btn-primary">Abrir Historial</button>
        </div>
      </form>

      <div class="undo-container">
        <button id="undoBtn" class="btn btn-secondary" disabled>Deshacer Borrado</button>
      </div>
    </div>

    <div class="card quick-notes">
      <h3>Quick Notes</h3>
      <form id="quickNoteForm">
        <div class="form-group">
          <label for="qnCategory">Categoría:</label>
          <input type="text" id="qnCategory" required>
        </div>
        <div class="form-group">
          <label for="qnTitle">Título:</label>
          <input type="text" id="qnTitle" required>
        </div>
        <div class="form-group">
          <label for="qnInquiry">Inquiry:</label>
          <textarea id="qnInquiry" rows="2" required></textarea>
        </div>
        <div class="form-group">
          <label for="qnAction">Action Taken:</label>
          <textarea id="qnAction" rows="2" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Agregar Quick Note</button>
      </form>
      <div id="quickNotesList"></div>
    </div>
  </div>

  <!-- Historial Modal -->
  <div class="modal" id="historyModal">
    <div class="modal-header">
      <h3>Historial</h3>
      <button class="close-btn" id="closeHistoryBtn">&times;</button>
    </div>
    <input type="text" id="historySearch" placeholder="Buscar en historial..." style="width:100%; padding:8px; margin-bottom:10px;">
    <div id="historyList"></div>
  </div>

  <div class="backdrop" id="backdrop"></div>

  <!-- Dark Mode Toggle -->
  <button class="dark-mode-toggle" id="darkModeToggle">
    <i class="fas fa-moon"></i>
  </button>

 <script>
// Variables y persistencia
let callHistory = JSON.parse(localStorage.getItem("callHistory") || "[]");
let savedQuickNotes = JSON.parse(localStorage.getItem("quickNotesData") || "null");
let quickNotesData = savedQuickNotes || {
    "Order Status":{
        "Processing":{inquiry:"CCI porque quería verificar el estado de su orden",action:"Informé que la orden aún estaba procesándose y di tiempo estimado de entrega."},
        "Shipped":{inquiry:"CCI porque quería verificar el estado de su orden",action:"Informé que la orden había sido enviada y proporcioné el rastreo."}
    },
    "New Order":{
        "Filters":{inquiry:"CCI para crear nueva orden",action:"Procesé nueva orden de filtros."},
        "Main Unit":{inquiry:"CCI para crear nueva orden",action:"Procesé nueva orden de unidad principal."},
        "Accessories":{inquiry:"CCI para crear nueva orden",action:"Procesé nueva orden de accesorios."}
    }
};
let isTyping=false, lastCleared=null;
let cexReasons = {
    Good:[
        "Customer was satisfied with the solution provided.",
        "Clear and fast resolution was achieved.",
        "Customer fully understood the process or instructions.",
        "Interaction was friendly and professional.",
        "Empathy and proactive support were provided.",
        "Customer appreciated the attention and information given.",
        "Courtesy item or policy exception was offered.",
        "Refund, replacement, or order was processed successfully.",
        "Clear next steps were explained to the customer.",
        "Customer was polite and cooperative during the interaction.",
        "NA"
    ],
    Neutral:[
        "No customer response yet, awaiting action or reply.",
        "Outcome still pending, more information or steps required.",
        "Clear explanation provided, but awaiting customer confirmation.",
        "Awaiting internal confirmation such as tracking, refund, or backoffice review.",
        "Neutral attitude displayed, no strong emotion expressed.",
        "NA"
    ],
    Bad:[
        "Customer was frustrated or dissatisfied with support.",
        "Issue persisted even after troubleshooting efforts.",
        "Product was defective or not working properly.",
        "Shipping or delivery delays caused frustration.",
        "Customer was unhappy with assessment or reluctant to troubleshoot.",
        "Escalation requested and supervisor involvement needed.",
        "Customer was unhappy with warranty coverage or outcome.",
        "Customer was unhappy with refund or credit amount offered.",
        "Long wait time or lack of promised callback caused dissatisfaction.",
        "Filter life or product quality concerns led to frustration.",
        "NA"
    ]
};

// Brand init
let brandSelect=document.getElementById("brand");
["Air Doctor","AquaTru","Better Bladder","Prosvent","IdealProstate","Walkfit","Superthotics","Rotorazer","Miracle Blade"].forEach(b=>{
    let opt=document.createElement("option"); opt.value=b; opt.innerText=b; brandSelect.appendChild(opt);
});

// Contact label
function updateContactLabel(){
    let type=document.getElementById("contactType").value;
    document.getElementById("contactFormLabel").innerText=type;
    document.getElementById("contactForm").placeholder=type+" #";
}

// Notes generation
function updateNotes(){
    let brand=document.getElementById("brand").value;
    let contactType=document.getElementById("contactType").value;
    let contactForm=document.getElementById("contactForm").value;
    let name=document.getElementById("name").value;
    let orderNumber=document.getElementById("orderNumber").value;
    let inquiry=document.getElementById("inquiry").value;
    let actionTaken=document.getElementById("actionTaken").value;
    let cex=document.getElementById("cexReason").value;
    let extra=document.getElementById("extraDetails")?.value.trim() || "";
    isTyping = inquiry.trim()!=="" || actionTaken.trim()!=="" || name.trim()!=="" || orderNumber.trim()!=="" || contactForm.trim()!=="" || extra!=="";

    document.getElementById("notes").value=
        `BRAND: ${brand} | CONTACT VIA: ${contactType} ${contactForm} | NAME: ${name} | Order#: ${orderNumber} | INQUIRY: ${inquiry} | ACTION TAKEN: ${actionTaken} | CEX: ${cex}` +
        (extra ? ` | EXTRA DETAILS: ${extra}` : "");
}

// CEX selection
function selectCEX(value){
    let select=document.getElementById("cexReason"); select.innerHTML="";
    cexReasons[value].forEach(opt=>{
        let o=document.createElement("option"); o.value=o.innerText=opt; select.appendChild(o);
    });
    updateNotes();
}

// Copy Notes
function copyNotes(){
    let notesBox=document.getElementById("notes");
    if(!notesBox.value.trim() || !document.getElementById("brand").value || !document.getElementById("contactForm").value) return alert("Complete todos los campos antes de guardar.");
    notesBox.select(); document.execCommand("copy"); saveCurrentCall();
    let btn=document.getElementById("copy-btn"); btn.innerText="Copied!";
    setTimeout(()=>btn.innerHTML='<i class="far fa-copy"></i> Copy and Save',1000);
}

// Save Call
function saveCurrentCall(){
    let noteText=document.getElementById("notes").value;
    if(noteText.trim()==="") return;
    callHistory.push({
        orderNumber:document.getElementById("orderNumber").value,
        name:document.getElementById("name").value,
        brand:document.getElementById("brand").value,
        contactType:document.getElementById("contactType").value,
        contactForm:document.getElementById("contactForm").value,
        inquiry:document.getElementById("inquiry").value,
        actionTaken:document.getElementById("actionTaken").value,
        cex:document.getElementById("cexReason").value,
        extra:document.getElementById("extraDetails")?.value.trim() || "",
        date:new Date().toLocaleString()
    });
    localStorage.setItem("callHistory",JSON.stringify(callHistory));
    renderHistory();
    isTyping=false;
}

// Render History with search
function renderHistory(){
    let list=document.getElementById("historyList"); list.innerHTML="";
    let query=document.getElementById("historySearch").value.toLowerCase();
    callHistory.slice().reverse().forEach((item,index)=>{
        if(query && !(`${item.orderNumber} ${item.name}`.toLowerCase().includes(query))) return;
        let li=document.createElement("li");
        li.innerText=`${item.orderNumber} - ${item.name} (${item.date})`;
        li.onclick=()=> loadCall(callHistory.length-1-index);
        list.appendChild(li);
    });
}

// Load call from history
function loadCall(index){
    let item=callHistory[index];
    if(!item) return;
    document.getElementById("brand").value=item.brand;
    document.getElementById("contactType").value=item.contactType;
    updateContactLabel();
    document.getElementById("contactForm").value=item.contactForm;
    document.getElementById("name").value=item.name;
    document.getElementById("orderNumber").value=item.orderNumber;
    document.getElementById("inquiry").value=item.inquiry;
    document.getElementById("actionTaken").value=item.actionTaken;
    selectCEX(item.cex.split(" ")[0] || "Good");
    setTimeout(()=>{ document.getElementById("extraDetails").value=item.extra || ""; updateNotes(); },10);
    toggleHistoryPanel(false);
}

// Dark Mode
let darkBtn=document.getElementById("darkModeBtn");
function applyDarkFromStorage(){
    if(localStorage.getItem("darkMode")==="true"){ 
        document.body.classList.add("dark"); 
        darkBtn.querySelector('i').className='fas fa-sun'; 
    } else { 
        document.body.classList.remove("dark"); 
        darkBtn.querySelector('i').className='fas fa-moon'; 
    }
}
darkBtn.addEventListener("click", ()=>{
    document.body.classList.toggle("dark");
    let icon=document.querySelector("#darkModeBtn i");
    if(document.body.classList.contains("dark")){icon.className="fas fa-sun"; localStorage.setItem("darkMode","true");}
    else{icon.className="fas fa-moon"; localStorage.setItem("darkMode","false");}
});

// History panel toggle
let backdrop=document.getElementById('historyBackdrop');
let panel=document.getElementById('historyPanel');
function toggleHistoryPanel(force){
    if(force===false){ panel.classList.remove('active'); backdrop.classList.remove('active'); return; }
    panel.classList.toggle('active');
    backdrop.classList.toggle('active');
    renderHistory();
}
backdrop.addEventListener('click', ()=>toggleHistoryPanel(false));

// Clear History
function clearHistory(){
    if(!confirm('¿Borrar todo el historial?')) return;
    callHistory=[]; localStorage.removeItem('callHistory'); renderHistory();
}

// Clear Form with Undo
function clearForm(){
    let inquiry=document.getElementById("inquiry").value.trim();
    let action=document.getElementById("actionTaken").value.trim();
    let extra=document.getElementById("extraDetails")?.value.trim() || "";

    // Solo guardar lastCleared si hay algo escrito
    if((inquiry || action || extra)){
        lastCleared = {
            brand: document.getElementById('brand').value,
            contactType: document.getElementById('contactType').value,
            contactForm: document.getElementById('contactForm').value,
            name: document.getElementById('name').value,
            orderNumber: document.getElementById('orderNumber').value,
            inquiry: inquiry,
            actionTaken: action,
            cexReason: document.getElementById('cexReason').value,
            extraDetails: extra,
            notes: document.getElementById('notes').value
        };
        document.getElementById('undoBtn').style.display='inline-block';
    } else {
        lastCleared = null;
        document.getElementById('undoBtn').style.display='none';
    }

    document.getElementById('macroForm').reset();
    document.getElementById('cexReason').innerHTML='';
    if(document.getElementById('extraDetails')) document.getElementById('extraDetails').value='';
    document.getElementById('notes').value='';
    isTyping=false;
    updateContactLabel();
}

// New Call
function newCall(){
    if(isTyping && document.getElementById("notes").value.trim()!=""){
        if(confirm("¿Guardar nota actual antes de limpiar?")) saveCurrentCall();
    }
    clearForm();
}

// Quick Notes UI
let toggleBtn=document.getElementById("toggleQuickNotes");
let quickCategories=document.getElementById("quickCategories");
let subOptions=document.getElementById("subOptions");
let manageToggle=document.getElementById('manageQuickToggle');
let managePanel=document.getElementById('manageQuick');

function renderQuickCategories(){
    quickCategories.innerHTML=''; subOptions.innerHTML='';
    for(let cat in quickNotesData){
        let btn=document.createElement('button'); btn.innerText=cat; btn.className='quick-btn';
        btn.onclick=()=>{
            subOptions.innerHTML=''; subOptions.style.display='flex';
            for(let sub in quickNotesData[cat]){
                let subBtn=document.createElement('button'); subBtn.innerText=sub; subBtn.className='sub-btn';
                subBtn.onclick=()=>{
                    let inquiryField=document.getElementById('inquiry');
                    let actionField=document.getElementById('actionTaken');
                    inquiryField.value = inquiryField.value ? inquiryField.value + " | " + quickNotesData[cat][sub].inquiry : quickNotesData[cat][sub].inquiry;
                    actionField.value = actionField.value ? actionField.value + " | " + quickNotesData[cat][sub].action : quickNotesData[cat][sub].action;
                    updateNotes();
                };
                subOptions.appendChild(subBtn);
            }
        };
        quickCategories.appendChild(btn);
    }
    let deleteSelect = document.getElementById('mqDeleteSelect'); deleteSelect.innerHTML='';
    for(let cat in quickNotesData){ 
        for(let sub in quickNotesData[cat]){
            let opt=document.createElement('option'); opt.value=`${cat}|||${sub}`; opt.textContent=`${cat} - ${sub}`; deleteSelect.appendChild(opt);
        }
    }
}

// Manage Quick Notes Actions
document.getElementById('addQuickBtn').addEventListener('click', ()=>{
    let cat=document.getElementById('mqCategory').value.trim();
    let title=document.getElementById('mqTitle').value.trim();
    let inquiry=document.getElementById('mqInquiry').value.trim();
    let action=document.getElementById('mqAction').value.trim();
    if(!cat || !title) return alert('Category y Title son obligatorios');
    if(!quickNotesData[cat]) quickNotesData[cat] = {};
    quickNotesData[cat][title] = {inquiry: inquiry || '', action: action || ''};
    localStorage.setItem('quickNotesData', JSON.stringify(quickNotesData));
    document.getElementById('mqCategory').value=''; document.getElementById('mqTitle').value=''; document.getElementById('mqInquiry').value=''; document.getElementById('mqAction').value='';
    renderQuickCategories();
    alert('Quick note añadida');
});

// Delete Quick Note
document.getElementById('deleteQuickBtn').addEventListener('click', ()=>{
    let val=document.getElementById('mqDeleteSelect').value;
    if(!val) return; 
    let [cat,sub]=val.split('|||');
    if(confirm(`Eliminar '${sub}' de '${cat}'?`)){
        delete quickNotesData[cat][sub];
        if(Object.keys(quickNotesData[cat]).length===0) delete quickNotesData[cat];
        localStorage.setItem('quickNotesData', JSON.stringify(quickNotesData));
        renderQuickCategories();
    }
});

// Edit Quick Note
document.getElementById('editQuickBtn').addEventListener('click', ()=>{
    let val = document.getElementById('mqDeleteSelect').value;
    if(!val) return alert('Selecciona una nota para editar.');
    let [cat, sub] = val.split('|||');
    if(!quickNotesData[cat] || !quickNotesData[cat][sub]) return alert('Nota no encontrada.');
    document.getElementById('mqCategory').value = cat;
    document.getElementById('mqTitle').value = sub;
    document.getElementById('mqInquiry').value = quickNotesData[cat][sub].inquiry;
    document.getElementById('mqAction').value = quickNotesData[cat][sub].action;
});

// Quick notes toggles
let isQuickOpen=false;
toggleBtn.addEventListener('click', ()=>{ isQuickOpen = !isQuickOpen; quickCategories.style.display = isQuickOpen ? 'flex' : 'none'; subOptions.style.display='none'; toggleBtn.innerText = isQuickOpen ? '-' : '+'; });
manageToggle.addEventListener('click', ()=>{ managePanel.style.display = managePanel.style.display==='none' ? 'block' : 'none'; });

// Input event binding
document.querySelectorAll('#macroForm input, #macroForm textarea, #macroForm select').forEach(el=>{
    el.addEventListener('input', ()=>{ 
        if(el.id==='contactType') updateContactLabel(); 
        updateNotes(); 
    });
});

// Extra Details input binding
document.getElementById("extraDetails")?.addEventListener("input", updateNotes);

// Inicialización
selectCEX('Good');
renderQuickCategories();
renderHistory();
applyDarkFromStorage();
</script>
</body>
</html>
